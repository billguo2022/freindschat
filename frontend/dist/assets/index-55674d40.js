import{_ as se,M as le,f as ue,u as re,m as ie,r as _,h as de,n as ce,i as l,j as _e,o as u,c,k as n,w as s,F as T,a,t as f,q as x,e as b,x as m,y as pe,l as ve,z as I,A as P,B as A,p as me,d as fe}from"./index-1aea0b7d.js";const ge=h=>(me("data-v-29f90413"),h=h(),fe(),h),he={class:"avatar-content"},ye=["src"],Fe={style:{display:"flex","align-items":"center","justify-content":"space-between",width:"100%"}},ke={class:"text"},xe={class:"chat-time"},be={key:0,class:"other-content"},we={style:{display:"flex","flex-direction":"column"}},Se={style:{color:"#FFFFFF"}},ze=["src"],Me={key:0,class:"my-talk-bubble"},Re={class:"talktext"},Ve=["src"],Ce={key:2,controls:""},je=["src"],Be={key:1,class:"my-content"},De={key:0,class:"my-talk-bubble"},Te={class:"talktext"},Ie=["src"],Pe={key:2,controls:""},Ae=["src"],Ne={style:{display:"flex","flex-direction":"column"}},Ue={style:{color:"#FFFFFF"}},$e=["src"],Ge=ge(()=>a("h4",{style:{"text-align":"center",padding:"10px"}},"Send pictures",-1)),Oe={style:{margin:"16px"}},qe={__name:"index",setup(h){const{socket:w}=le.getInstance(),i=ue();re();const S=ie(),p=_({}),y=_([i.user().value.id,S.params.id].sort().join("_")),r=_({content:"",recipient_id:"",image_url:"",audio_url:"",token:i.token().value,room:y.value}),v=_(null),z=_([]),j=()=>{navigator.mediaDevices.getUserMedia({audio:!0}).then(e=>{v.value=new MediaRecorder(e),z.value=[],v.value.ondataavailable=t=>{t.data.size>0&&z.value.push(t.data)},v.value.start()}).catch(e=>{console.error("Recording failed:",e)})},M=()=>{v.value&&v.value.state!=="inactive"&&(v.value.stop(),v.value.onstop=()=>{const e=new Blob(z.value,{type:"audio/mp3"});N(e)})},N=e=>{const t=new FormData;t.append("audio",e,"audio.mp3"),I(window.location.origin+"/api/file/audio",{method:"POST",data:t,headers:{Authorization:"bearer "+i.token().value}}).then(d=>{d.data.code===200&&(console.log(d.data.data),r.value.audio_url=d.data.data,R())}).catch(d=>{console.error("Sending audio failed:",d)})},g=_(i.group(y.value));de(()=>{ce.GetUserInfoById({id:S.params.id}).then(e=>{e.code===200&&(p.value=e.data)}),i.joined_user(i.user().value.id,S.params.id),w.on("joined_user_message",e=>{g.value=e.message,i.group(y.value).value=e.message})}),w.on("user_message",e=>{console.log(e);let t=[...g.value,e.message];g.value=t,i.group(y.value).value=g.value});const R=()=>{r.value.image_url===""&&r.value.audio_url===""&&r.value.content===""||(r.value.recipient_id=p.value.id,w.emit("privateChat",r.value),r.value.content="",r.value.image_url="",r.value.audio_url="",k.value=!1,F.value=[],console.log(r.value))},F=_([]),U=e=>{const t=e.type==="image/jpeg"?512e3:1024e3;return e.size>=t},$=e=>/(jpg|jpeg|png|JPG|PNG)/i.test(e.type)?!0:(P("Please upload images in the correct format"),!1),G=e=>{console.log("submit",e)},O=e=>{e.status="uploading",e.message="上传中...";let t=new FormData;t.append("file",e.file),I({url:window.location.origin+"/api/file/avatar/group",method:"POST",data:t,headers:{"content-type":"multipart/form-data",Authorization:"bearer "+i.token().value}}).then(d=>{d.data.code===200&&(e.status="done",P("success！"),r.value.image_url=d.data.data,F.value=[{url:d.data.data}])})},k=_(!1),q=()=>{k.value=!0};return(e,t)=>{const d=l("van-icon"),B=l("el-col"),V=l("van-tag"),E=l("el-row"),J=l("el-header"),L=l("el-main"),Y=l("Microphone"),C=l("el-icon"),H=l("Picture"),K=l("Right"),D=l("van-field"),Q=l("van-cell-group"),W=l("el-footer"),X=l("el-container"),Z=l("van-uploader"),ee=l("van-button"),oe=l("van-form"),te=l("van-popup"),ae=_e("autofocus");return u(),c(T,null,[n(X,null,{default:s(()=>[n(J,null,{default:s(()=>[n(E,{gutter:12},{default:s(()=>[n(B,{span:4},{default:s(()=>[a("div",{class:"left-back",onClick:t[0]||(t[0]=o=>e.$router.back())},[n(d,{name:"arrow-left",size:"20"})])]),_:1}),n(B,{span:16},{default:s(()=>[a("div",he,[a("img",{src:p.value.avatar,alt:""},null,8,ye),a("div",Fe,[a("span",ke,f(p.value.username),1),a("span",null,[p.value.online===1?(u(),x(V,{key:0,type:"success"},{default:s(()=>[b("online")]),_:1})):m("",!0),p.value.online===0?(u(),x(V,{key:1,type:"danger"},{default:s(()=>[b("offline")]),_:1})):m("",!0),p.value.online===2?(u(),x(V,{key:2,type:"warning"},{default:s(()=>[b("busy")]),_:1})):m("",!0)])])])]),_:1})]),_:1})]),_:1}),n(L,null,{default:s(()=>[(u(!0),c(T,null,pe(g.value,(o,ne)=>(u(),c("div",{key:ne},[a("div",xe,f(o.created_at),1),o.sender.id!==A(i).user().value.id?(u(),c("div",be,[a("div",we,[a("span",Se,f(o.sender.username),1),a("img",{src:o.sender.avatar,alt:"",style:{width:"50px",height:"50px","margin-left":"10px"}},null,8,ze)]),o.content?(u(),c("div",Me,[a("div",Re,[a("p",null,f(o.content),1)])])):o.image_url?(u(),c("img",{key:1,src:o.image_url,alt:"",style:{"border-radius":"0"}},null,8,Ve)):o.audio_url?(u(),c("audio",Ce,[a("source",{src:o.audio_url,type:"audio/mp3"},null,8,je)])):m("",!0)])):m("",!0),o.sender.id===A(i).user().value.id?(u(),c("div",Be,[o.content?(u(),c("div",De,[a("div",Te,[a("p",null,f(o.content),1)])])):o.image_url?(u(),c("img",{key:1,src:o.image_url,alt:"",style:{"border-radius":"0"}},null,8,Ie)):o.audio_url?(u(),c("audio",Pe,[a("source",{src:o.audio_url,type:"audio/mp3"},null,8,Ae)])):m("",!0),a("div",Ne,[a("span",Ue,f(o.sender.username),1),a("img",{src:o.sender.avatar,alt:"",style:{width:"50px",height:"50px","margin-left":"10px"}},null,8,$e)])])):m("",!0)]))),128))]),_:1}),n(W,null,{default:s(()=>[n(Q,{inset:""},{default:s(()=>[ve((u(),x(D,{modelValue:r.value.content,"onUpdate:modelValue":t[3]||(t[3]=o=>r.value.content=o),placeholder:"Send Your Message"},{"left-icon":s(()=>[n(C,{size:"25",color:"#FFFFFF",onMousedown:j,onMouseup:M,onTouchstart:j,onTouchmove:M,onTouchend:M},{default:s(()=>[n(Y)]),_:1}),n(C,{size:"25",color:"#FFFFFF",onClick:t[1]||(t[1]=o=>q()),style:{"margin-left":"20px"}},{default:s(()=>[n(H)]),_:1})]),"right-icon":s(()=>[n(C,{size:"25",color:"#FFFFFF",onClick:t[2]||(t[2]=o=>R())},{default:s(()=>[n(K)]),_:1})]),_:1},8,["modelValue"])),[[ae]])]),_:1})]),_:1})]),_:1}),n(te,{show:k.value,"onUpdate:show":t[6]||(t[6]=o=>k.value=o),position:"bottom",style:{height:"35%"}},{default:s(()=>[Ge,n(oe,{onSubmit:G},{default:s(()=>[n(D,{name:"uploader",label:"avatar"},{input:s(()=>[n(Z,{modelValue:F.value,"onUpdate:modelValue":t[4]||(t[4]=o=>F.value=o),"max-size":U,"after-read":O,"before-read":$,reupload:"","max-count":"1"},null,8,["modelValue"])]),_:1}),a("div",Oe,[n(ee,{round:"",block:"",type:"primary","native-type":"submit",onClick:t[5]||(t[5]=o=>R())},{default:s(()=>[b(" submit ")]),_:1})])]),_:1})]),_:1},8,["show"])],64)}}},Je=se(qe,[["__scopeId","data-v-29f90413"]]);export{Je as default};
